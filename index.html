<!doctype html>
<html>
<head>
<title>Icon Editor</title>
<style>
	/* Icon editor */

html {
	height: 100%;
	width: 100%;
    font-family: sans-serif;
}
body {
	margin: 50px;
}
canvas {
	border: solid 1px #888;
}
.hbox {
	display: inline-block;
	vertical-align: top;
}
#palette button {
	display: block;
	width: 70px;
    text-shadow: 1px 0 2px white, -1px 0 2px white, 0 -1px 2px white, 0 1px 2px white;
}
button.selected {
	background-color: "yellow";
	border-width: 2px;
	font-weight: bold;
}
span {
	margin-bottom: 20px;
	padding: 3px 5px 3px 12px;
	letter-spacing: 5px;
	border: solid 1px black;
	background: white;
}
#selected {
	width: 50px;
	height: 50px;
	border: solid 10px;
	border-color: black;
}
.smaller {
	font-size: 14px;
}
#tools button {
	display: block;
}
</style>
</head>
<body>

<div>
<span>icon editor</span>
&middot
<input id=name></input>
<select id="library"></select>
<button id="delet">delete</button>
</div>
<br>

<div>

<div class=hbox>
<div id=tools></div>
</div>


<div class=hbox>
<div id=palette></div>
<div id=selected>&nbsp;</div>
</div>

<div class=hbox>
<canvas id=editor   width=300 height=300></canvas>
</div>

<div class="hbox smaller">
<canvas class=preview width=16  height=16 ></canvas>
<canvas class=preview width=24  height=24 ></canvas>
<canvas class=preview width=32  height=32 ></canvas>
<canvas class=preview width=48  height=48 ></canvas>
<canvas class=preview width=64  height=64 ></canvas>
<br>
<br>
background
<button id=dark>dark</button>
<button id=lite>lite</button>
<button id=back>back</button>
<br>
<br>
<button id=neww>new</button>
<button id=fill>fill/clear</button>

</div>

<script>
function $(s) { return document.querySelector(s); }
function $$(s) { return document.querySelectorAll(s); }

const floor = Math.floor, min = Math.min, max = Math.max;

let RES = 16;
let IMAGE = Array(RES * RES).fill().map(() => "rgba(0,0,0,0)");
let MOUSEI, MOUSEJ;
let TOOL = 'paint';


function draw(can, borderStyle) {
	let ctx = can.getContext('2d');
	ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
	let dx = ctx.canvas.width / RES;
	let dy = ctx.canvas.height / RES;
	for (let index = 0; index < RES * RES; index += 1) {
		let i = index % RES;
		let j = floor(index / RES);
		ctx.fillStyle = IMAGE[index];
		ctx.fillRect(i * dx, j * dy, dx, dy);
		if (borderStyle) {
			ctx.beginPath();
			ctx.moveTo( i   *dx, (j+1)*dy);
			ctx.lineTo( i   *dx,  j   *dy);
			ctx.lineTo((i+1)*dx,  j   *dy);
			ctx.setLineDash([2,2]);
			ctx.strokeStyle = borderStyle;
			ctx.stroke();
			if(i === MOUSEI && j === MOUSEJ) {
				ctx.strokeStyle = 'red';
				ctx.strokeRect(i * dx, j * dy, dx, dy);
			}
		}
	}

}

// Button default is to call the function whose name matches the id

for (let button of $$("button")) {
	if (window[button.id]) {
		button.addEventListener('click', e => window[e.target.id](e));
		button.addEventListener('contextmenu', e => window[e.target.id](e));
	}
}

// Create palette
for (cc of "black|grey|silver|white|red|green|blue|cyan|magenta|yellow|erase/rgba(0,0,0,0)".split("|")) {
	let button = $("#palette").appendChild(document.createElement("button"));
	cc = cc.split('/');
	let label = cc.shift();
	let color = cc.shift() || label;
	button.style.backgroundColor = color;
	button.innerText = label;
	button.addEventListener('click', e => {
		let c = e.target.style.backgroundColor;
		$("#selected").style.backgroundColor = c;
	});
	button.addEventListener('contextmenu', e => {
		let c = e.target.style.backgroundColor;
		$("#selected").style.borderColor = c;
	});
}
$("#selected").style.borderColor = "rgba(0,0,0,0)";
$("#selected").style.backgroundColor = "black";


// Create tools
for (tt of "paint/default|flood/move".split("|")) {
	let button = $("#tools").appendChild(document.createElement("button"));
	[tt,cc] = tt.split('/');
	button.innerText = tt;
	button.id = tt;
	button.style.cursor = cc
	button.addEventListener('click', e => {
		TOOL = e.target.id;
		$("#editor").style.cursor = e.target.style.cursor;
		for (let b of $$("#tools button")) {
			b.classList[(b.id === TOOL) ? "add" : "remove"]("selected");
		}
	});
	if (button.id == TOOL) button.classList.add("selected");
}

// Handle mouse
document.oncontextmenu = e => e.target.className === 'preview';
$("#editor").addEventListener('mousedown', tool);
$("#editor").addEventListener('mousemove', tool);
$("#editor").addEventListener('mouseleave', e => {
	MOUSEI = MOUSEJ = null;
	draw($("#editor"), "#888");
});

// Tools

function tool(e) {
	e.stopImmediatePropagation();

	MOUSEI = min(RES-1, max(0, floor(RES * e.offsetX / e.target.width)));
	MOUSEJ = min(RES-1, max(0, floor(RES * e.offsetY / e.target.height)));

	if (e.which === 0) {
		draw($("#editor"), "#888");
		return; // mouseover with no mouse buttons down
	}

	window[TOOL](e);
	update();
	return false;
}


function paint(e) {
	let index = MOUSEI + MOUSEJ * RES;
	IMAGE[index] = paintColor(e) || IMAGE[index];
}

function flood(e, i, j, c) {
	if (i === undefined) {
		i = MOUSEI;
		j = MOUSEJ;
		c = IMAGE[i + j * RES];
		if (paintColor(e) === c) return; // else infinite recursion
	}
	if (c === IMAGE[i + j * RES]) {
		IMAGE[i + j * RES] = paintColor(e);
		if (i < RES - 1) flood(e, i + 1, j, c);
		if (j < RES - 1) flood(e, i, j + 1, c);
		if (i > 0)       flood(e, i - 1, j, c);
		if (j > 0)       flood(e, i, j - 1, c);
	}
}


function update() {
	draw($("#editor"), "#888");
	for (can of $$(".preview")) { draw(can); }

	let name = $("#name").value;
	let library = JSON.parse(localStorage.library || '{}');
	if (name.length) library[name] = IMAGE;
	$("#library").innerHTML = "";
	let something = false;
	for (entry in library) {
		let option = $("#library").appendChild(document.createElement("option"));
		option.innerText = entry;
		option.name = entry;
		if (entry === name) something = option.selected = true;
	}
	if (!something) {
		let option = $("#library").insertBefore(document.createElement("option"), $("#library").firstChild);
		option.innerHTML = "Load &darr;";
		option.selected = true;
	}
	localStorage.library = JSON.stringify(library);
	localStorage.last = name;
}

$("#name").addEventListener("change", update);

$("#library").addEventListener('change', e => {
	let library = JSON.parse(localStorage.library || '{}');
	let opt = $("#library").options[$("#library").selectedIndex];
	$("#name").value = opt.name;
	IMAGE = library[opt.name];
	update();
});

function delet(e) {
	let library = JSON.parse(localStorage.library || '{}');
	delete library[$("#name").value];
	localStorage.library = JSON.stringify(library);
	$("#name").value = "";
	update();
}

// Backgrounds

function lite(e) {
	$("html").style.background = `
	 repeating-linear-gradient( 45deg, rgba(255,255,255,0) 0 4px, rgba(255,0,0,0.05) 4px 8px),
	 repeating-linear-gradient(-45deg, rgba(255,255,255,0) 0 4px, rgba(0,0,255,0.05) 4px 8px)`;
}

function dark(e) {
	$("html").style.background = `
	 repeating-linear-gradient( 45deg, rgba(0,0,0,0.4) 0 20px, rgba(55,0,0,0.4) 20px 40px),
	 repeating-linear-gradient(-45deg, rgba(0,0,0,1.0) 0 20px, rgba(0,0,55,1.0) 20px 40px)`;
}

function back(e) {
	$("html").style.background = paintColor(e);
}

function paintColor(e) {
	if (e.which === 1) {
		return $("#selected").style.backgroundColor;
	} else if (e.which === 3) {
		return $("#selected").style.borderColor;
	}
}

// actions

function neww(e) {
	$("#name").value = "";
	IMAGE = IMAGE.map(c => "rgba(0,0,0,0)");
	update();
}

function fill(e) {
	IMAGE = IMAGE.map(c => paintColor(e));
	update();
}

function initialize() {
	lite();

	let library = JSON.parse(localStorage.library || '{}');
	$("#name").value = localStorage.last || "";
	IMAGE = library[$("#name").value] || IMAGE;
	update();
}
initialize();

</script>
</body>
</html>